{% extends 'report/_asset_mangement_partials/_pageBase.html.twig' %}

{% import _self as Macros %}
{% macro grid(table_overview_monthly, anlage) %}
    <tr>
        <td class="tr_first_column" style="text-align: right;">Yield (Grid meter)</td>

        {% for data in table_overview_monthly.powerEvu %}
            <td class="tr_next_columns">{{ data|number_format(0, ',', '.') }}</td>
        {% endfor %}
    </tr>
{% endmacro %}
{% macro expectedPvSyst(table_overview_monthly, anlage) %}
    <tr>
        <td class="tr_first_column" style="text-align: right;">Expected PV SYST</td>
        {% for data in table_overview_monthly.expectedPvSyst %}
            <td class="tr_next_columns">{{ data|number_format(0, ',', '.') }}</td>
        {% endfor %}
    </tr>
{% endmacro %}
{% macro expectedG4N(table_overview_monthly, anlage) %}
    <tr>
        <td class="tr_first_column" style="text-align: right;">Expected g4n</td>
        {% for data in table_overview_monthly.powerExpEvu %}
            <td class="tr_next_columns">{{ data|number_format(0, ',', '.') }}</td>
        {% endfor %}
    </tr>
{% endmacro %}
{% macro inverterOut(table_overview_monthly, anlage) %}
    <tr>
        <td class="tr_first_column" style="text-align: right;">Inverter out</td>
        {% for data in table_overview_monthly.powerAct %}
            <td class="tr_next_columns">{{ data|number_format(0, ',', '.') }}</td>
        {% endfor %}
    </tr>
{% endmacro %}

{% block page %}
    <h3 style="color: {{ anlage.eigner.fontColor2 }};">Production & Capacity factor</h3>
    <span class="subheadline">Yearly expected vs. actuals</span>
    <table >
        <tr>
            <td colspan="2" style="text-align: left">
                <table class="asset_report_table_operations_data" style="width: 100%!important;">
                    <thead>
                    <tr>
                        <th rowspan="3" class="table-center">Production</th>
                        {% set counter = 1 %}
                        {% for data in dataMonthArray %}
                            <th style="text-align: center;width:6.5%">{{ data }}</th>
                            {% set counter = counter+1 %}
                        {% endfor %}
                    </tr>

                    <tr>
                        {% for data in dataMonthArray %}
                            <th style="text-align: center;width:6.5%">[kWh]</th>
                        {% endfor %}
                    </tr>

                    </thead>
                    <tbody>
                    {% set powerEvuTotal = 0 %}
                    {% if (anlage.hasGrid ) %}
                            {% for data in table_overview_monthly.powerEvu %}
                                {% set powerEvuTotal = powerEvuTotal+data %}
                            {% endfor %}
                            {{ Macros.grid(table_overview_monthly, anlage)}}
                            {% if (anlage.hasPVSYST == true) %}
                                {{ Macros.expectedPvSyst(table_overview_monthly, anlage) }}
                            {% endif %}
                            {{ Macros.expectedG4N(table_overview_monthly, anlage) }}
                            {{ Macros.inverterOut(table_overview_monthly, anlage, powerEvuTotal) }}
                    {% else %}
                        {% for data in table_overview_monthly.powerAct %}
                            {% set powerEvuTotal = powerEvuTotal+data %}
                        {% endfor %}
                        {{ Macros.inverterOut(table_overview_monthly, anlage) }}
                        {% if (anlage.hasPVSYST == true) %}
                            {{ Macros.expectedPvSyst(table_overview_monthly, anlage) }}
                        {% endif %}
                        {{ Macros.expectedG4N(table_overview_monthly, anlage) }}
                    {% endif %}

                    </tbody>
                </table>
                <span style="text-align:left">
                    AC losses to grid meter considered<br>
                    {% if (anlage.DataSourceAM != null) %}
                        <b>Source:</b><br>
                        {{ anlage.DataSourceAM | raw }}
                    {% endif %}
                </span>
            </td>
        </tr>
        <tr>
            <td style="vertical-align: top;">


                <table>
                    <tr>
                        <td style="text-align: left">
                            <span class="subheadline" style="margin-bottom: 5px !important; margin-top: 15px !important">Capacity Factor</span><br>
                            <img width="130" src="{{ absolute_url(asset('goldbeck/reports/asset_management/cf.png')) }}"></td>
                    </tr>
                </table>
                <table class="asset_report_table_operations_data" style="width: 300px!important;">
                    <thead>
                    <tr>
                        <th style="text-align: center;">Month</th>
                        <th style="text-align: center;">Day</th>
                        <th style="text-align: center;">hours [h]</th>
                        <th style="text-align: center;">CF [%]</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% set average = 0 %}
                    {% set sumdays = 0 %}
                    {% set sumhours = 0 %}
                    {% set itemsinarray = 0 %}
                    {% for data in dataCfArray %}
                        {% set sumdays = sumdays+data.days %}
                        {% set sumhours = sumhours+data.hours %}
                        {% set average = average+data.cf %}
                        <tr><td class="tr_first_column" style="text-align: center;">{{ data.month }}</td><td class="tr_next_columns">{{ data.days }}</td><td class="tr_next_columns">{{ data.hours }}</td><td class="tr_next_columns">{{ data.cf|number_format(2, ',', '.') }}</td></tr>
                        {% set itemsinarray = loop.length %}
                    {% endfor %}
                    <tr><td colspan="3" style="font-weight: bold">Average<td style="font-weight: bold">{{ (average/reportmonth)|number_format(3, ',', '.') }}</td></tr>
                    <tr>
                        <td class="tr_first_column" style="text-align: center;">TOTAL</td>
                        <td class="tr_first_column" style="text-align: right;">{{ sumdays }}</td>
                        <td class="tr_first_column" style="text-align: right;">{{ sumhours }}</td>
                        <td class="tr_first_column" style="text-align: right;">{{ (((powerEvuTotal/1000)/((anlage.kwPeak/1000)*sumhours))*100)|round(3, 'ceil')|number_format(2, ',', '.') }}</td>
                    </tr>
                    </tbody>
                </table>
            </td>
            <td style="text-align: right!important; float: right;">
                {{ operations_right|raw }}
            </td>
        </tr>
    </table>
{%  endblock page %}